name: Build SL3000 Firmware

on:
  workflow_dispatch:   # ✅ 只手动触发，不会自动构建

env:
  TZ: Asia/Shanghai
  PROFILE: sl3000-emmc
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  DL_DIR: ${{ github.workspace }}/dl
  BUILD_LOG: ${{ github.workspace }}/build.log

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ✅ 最大化磁盘空间（Ubuntu 24.04 最安全的清理方式）
      - name: Optimize Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo docker system prune -af || true
          df -h

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3 \
            rsync unzip zlib1g-dev file wget ccache

      # ✅ ccache 缓存
      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ env.PROFILE }}-${{ hashFiles('configs/sl3000.config') }}
          restore-keys: |
            ccache-${{ env.PROFILE }}-
            ccache-

      # ✅ dl 缓存
      - name: Restore dl
        uses: actions/cache@v4
        with:
          path: dl
          key: dl-${{ hashFiles('feeds.conf*', 'scripts/download.pl') }}
          restore-keys: |
            dl-

      - name: Prepare Build Config
        run: |
          cp configs/sl3000.config .config
          yes "" | make defconfig
          echo "Using profile: $PROFILE"
          grep sl3000 .config || true

      - name: Print ccache status before build
        run: ccache -s || true

      - name: Build Firmware
        env:
          CCACHE_DIR: ${{ env.CCACHE_DIR }}
        run: |
          export CC="ccache gcc"
          export CXX="ccache g++"
          make -j$(nproc) V=s | tee "$BUILD_LOG"

      - name: Print ccache status after build
        run: ccache -s || true

      - name: Collect Artifacts
        run: |
          mkdir -p artifacts
          find bin/targets -type f \
            \( -name "*${PROFILE}*sysupgrade*.bin" -o -name "*.bin" -o -name "*.itb" -o -name "*.img*" \) \
            -exec cp -v {} artifacts/ \; || true

          cp .config artifacts/config.${PROFILE}.used || true
          cp "$BUILD_LOG" artifacts/build.${PROFILE}.log || true

          BIN_COUNT=$(ls artifacts/*.bin 2>/dev/null | wc -l || echo 0)
          if [ "$BIN_COUNT" -eq 0 ]; then
            echo "ERROR: No bin images collected!"
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-${{ env.PROFILE }}-firmware
          path: artifacts/

      # ✅ 自动发布 Release（只在手动触发时执行）
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: sl3000-${{ env.PROFILE }}-${{ github.run_number }}
          name: SL3000 Firmware Build #${{ github.run_number }}
          body: |
            ✅ 自动构建固件  
            ✅ Profile: ${{ env.PROFILE }}  
            ✅ 构建编号: ${{ github.run_number }}  
            ✅ 构建时间: ${{ env.TZ }}

          files: artifacts/*
