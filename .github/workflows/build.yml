name: Build SL3000 Firmware

on:
  workflow_dispatch:
  push:
    branches:
      - sl3000

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-distutils \
            rsync unzip zlib1g-dev file wget ccache

      - name: Setup ccache
        uses: actions/cache@v3
        with:
          path: .ccache
          key: ccache-sl3000
          restore-keys: ccache-

      - name: Prepare Build Config
        run: |
          cp configs/sl3000.config .config
          make defconfig

      - name: Update Feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build Firmware
        run: |
          make -j$(nproc) || make -j1 V=s

      - name: Collect Artifacts
        run: |
          mkdir -p artifacts
          find bin/targets -type f \
            \( -name "*sl3000*sysupgrade*.bin" -o -name "*.bin" -o -name "*.itb" -o -name "*.img*" \) \
            -exec cp -v {} artifacts/ \;
          cp .config artifacts/config.used || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: sl3000-firmware
          path: artifacts/
