name: Build SL3000 Firmware

on:
  workflow_dispatch:
  push:
    branches:
      - sl3000

env:
  TZ: Asia/Shanghai
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  DL_DIR: ${{ github.workspace }}/dl
  BUILD_LOG: ${{ github.workspace }}/build.log
  PROFILE: sl3000-emmc

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Basic info
        run: |
          echo "Runner disk usage before cleanup:"
          df -h
          uname -a

      - name: Free disk space (minimal but effective)
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc || true
          sudo rm -rf /usr/local/lib/android || true
          df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-distutils \
            rsync unzip zlib1g-dev file wget ccache

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ env.PROFILE }}-${{ hashFiles('configs/sl3000.config') }}
          restore-keys: |
            ccache-${{ env.PROFILE }}-
            ccache-

      - name: Restore dl cache
        uses: actions/cache@v4
        with:
          path: dl
          key: dl-${{ hashFiles('feeds.conf*', 'scripts/download.pl') }}
          restore-keys: |
            dl-

      - name: Prepare build config
        run: |
          set -e
          cp configs/sl3000.config .config
          yes "" | make defconfig
          echo "Final .config:"
          grep -E "TARGET_mediatek|TARGET_mediatek_filogic|sl3000" .config || true

      # 如你确实需要更新/安装 feeds，打开下面两步的注释即可
      # - name: Update feeds (manual opt-in only)
      #   run: |
      #     ./scripts/feeds update -a
      #
      # - name: Install feeds (manual opt-in only)
      #   run: |
      #     ./scripts/feeds install -a

      - name: Print ccache status before build
        run: |
          ccache -s || true

      - name: Build firmware
        env:
          CCACHE_DIR: ${{ env.CCACHE_DIR }}
        run: |
          set -e
          export CC="ccache gcc"
          export CXX="ccache g++"
          # 带日志输出，便于问题归因
          make -j"$(nproc)" V=s | tee "$BUILD_LOG"

      - name: Print ccache status after build
        run: |
          ccache -s || true

      - name: Collect artifacts
        run: |
          set -e
          mkdir -p artifacts

          # 收集固件
          find bin/targets -type f \
            \( -name "*${PROFILE}*sysupgrade*.bin" -o -name "*.bin" -o -name "*.itb" -o -name "*.img*" \) \
            -exec cp -v {} artifacts/ \; || true

          # 保存配置和日志
          cp .config artifacts/config.${PROFILE}.used || true
          cp "${BUILD_LOG}" artifacts/build.${PROFILE}.log || true

          BIN_COUNT=$(ls artifacts/*.bin 2>/dev/null | wc -l || echo 0)
          if [ "$BIN_COUNT" -eq 0 ]; then
            echo "ERROR: No bin images collected!"
            echo "Collected files:"
            ls -R artifacts || true
            exit 1
          fi

          echo "Collected bin images:"
          ls -l artifacts/*.bin

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sl3000-${{ env.PROFILE }}-firmware
          path: artifacts/
