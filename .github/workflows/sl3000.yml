name: Build SL3000 Firmware

on:
  workflow_dispatch:
  push:
    branches:
      - sl3000

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        target:
          - arch: mediatek
            subtarget: filogic
            profile: sl3000-emmc

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Environment
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev \
            libssl-dev python3 python3-distutils rsync unzip zlib1g-dev

      - name: Cache ccache
        uses: actions/cache@v3
        with:
          path: .ccache
          key: ccache-${{ matrix.target.profile }}
          restore-keys: ccache-

      - name: Prepare OpenWrt Build
        run: |
          echo "Using profile: ${{ matrix.target.profile }}"
          cp configs/sl3000.config .config
          make defconfig

      - name: Update Feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Build Firmware
        run: |
          make -j$(nproc) || make -j1 V=s

      - name: Collect Artifacts
        run: |
          mkdir -p artifacts
          find bin/targets -type f \
            \( -name "*${{ matrix.target.profile }}*sysupgrade*.bin" -o -name "*.bin" -o -name "*.itb" -o -name "*.img*" \) \
            -exec cp -v {} artifacts/ \;
          cp .config artifacts/config.used || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: sl3000-firmware
          path: artifacts/
